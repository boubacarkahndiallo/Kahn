<!-- resources/views/layouts/header.blade.php -->

<!-- Start Main Top -->
<div class="main-top">
    <div class="container-fluid">
        <div class="row">
            <div class="col-lg-6 col-md-6 col-sm-12 col-xs-12">
                <div class="custom-select-box">
                    <select id="currency" class="selectpicker show-tick form-control" data-placeholder="GNF">
                        <option>GNF</option>
                        <option>FCFA</option>
                        <option>USD</option>
                        <option>EURO</option>
                    </select>
                </div>
                <div class="right-phone-box">
                    <p>Tél. : <a href="tel:+224623248567"> +224 623 24 85 67</a></p>
                </div>
                <div class="our-link">
                    <ul>
                        <li><a href="{{ route('app_about') }}"><i class="fas fa-info-circle s_color"></i> Info </a></li>
                        <li><a href="{{ route('app_contact') }}"><i class="fas fa-headset"></i> Contactez-nous </a></li>
                    </ul>
                </div>
            </div>
            <div class="col-lg-6 col-md-6 col-sm-12 col-xs-12">
                <div class="login-box">
                    <select id="user-action" class="selectpicker show-tick form-control" data-placeholder="Connexion">
                        <option>S’inscrire</option>
                        <option>Déconnexion</option>
                    </select>
                </div>
                <div class="text-slid-box">
                    <div id="offer-box" class="carouselTicker">
                        <ul class="offer-box">
                            <li><i class="fab fa-opencart"></i> Des produits agricoles 100% frais</li>
                            <li><i class="fab fa-opencart"></i> Variété de produits pour répondre à vos besoins</li>
                            <li><i class="fab fa-opencart"></i> Commandez et faites-vous livrer rapidement</li>
                            <li><i class="fab fa-opencart"></i> Soutenons les producteurs locaux</li>
                            <li><i class="fab fa-opencart"></i> L’agriculture au service de votre assiette</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<!-- End Main Top -->

<header class="main-header">
    <!-- Start Navigation -->
    <nav class="navbar navbar-expand-lg navbar-light bg-light navbar-default bootsnav">
        <div class="container">
            <div class="navbar-header">
                <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbar-menu"
                    aria-controls="navbars-rs-food" aria-expanded="false" aria-label="Toggle navigation">
                    <i class="fa fa-bars"></i>
                </button>
                <a class="navbar-brand" href="{{ route('app_accueil') }}"><img src="images/logo1.png" class="logo"
                        alt="Logo"></a>
            </div>

            <div class="collapse navbar-collapse" id="navbar-menu">
                <ul class="nav navbar-nav ml-auto" data-in="fadeInDown" data-out="fadeOutUp">
                    <li class="nav-item ">
                        <a class="nav-link @if (Request::route()->getName() == 'app_accueil') active @endif"
                            aria-current="page" href="{{ route('app_accueil') }}">Accueil</a>
                    </li>
                    <li class="dropdown">
                        <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown">Personnel</a>
                        <ul class="dropdown-menu">
                            <li> <a class="nav-link @if (Request::route()->getName() == 'admin.index') active @endif"
                                    aria-current="page" href="{{ route('admin.users.index') }}">Utilisateur</a>
                            </li>
                            <li><a href="{{ route('clients.index') }}">Clients</a></li>
                            <li><a href="#">Fournisseurs</a></li>
                        </ul>
                    </li>
                    <li class="dropdown">
                        <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown">Produits</a>
                        <ul class="dropdown-menu">
                            <li><a href="{{ route('produits.index') }}">Ajout produit</a></li>
                            <li><a href="{{ route('produits.allproduit') }}">Tous les produits</a></li>
                            <li><a href="{{ route('app_legumes') }}">Légumes</a></li>
                            <li><a href="#">Fruits</a></li>
                            <li><a href="#">Poissons & Poulets</a></li>
                        </ul>
                    </li>

                    <li class="dropdown">
                        <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown">Commandes</a>
                        <ul class="dropdown-menu">
                            <li><a href="{{ route('commandes.index') }}">Mes commandes</a></li>
                            <li><a href="{{ route('livraisons.index') }}">Livraisons</a></li>
                        </ul>
                    </li>
                    <li class="nav-item"><a class="nav-link" href="{{ route('app_contact') }}">Contact</a></li>
                </ul>
            </div>

            <div class="attr-nav">
                <ul>
                    <li class="search"><a href="#"><i class="fa fa-search"></i></a></li>
                    <li class="side-menu">
                        <a href="#">
                            <i class="fa fa-shopping-cart"></i>
                            <span class="badge" id="cart-count">0</span>
                            <p>Panier</p>
                        </a>
                    </li>
                </ul>
            </div>
        </div>

        <!-- Panier -->
        <div class="side">
            <a href="#" class="close-side"><i class="fa fa-times"></i></a>
            <li class="cart-box">
                <ul class="cart-list">
                    <li class="total">
                        <a href="#" class="btn btn-default hvr-hover btn-cart">Voir</a>
                        <span class="float-right"><strong>Total</strong>: 0 GNF</span>
                    </li>
                </ul>
            </li>
        </div>
        <!-- End Panier -->
    </nav>
</header>

<div class="top-search">
    <div class="container">
        <div class="input-group">
            <span class="input-group-addon"><i class="fa fa-search"></i></span>
            <input type="text" class="form-control" placeholder="Recherchez vos produits agricoles...">
            <span class="input-group-addon close-search"><i class="fa fa-times"></i></span>
        </div>
    </div>
</div>
<!-- End Top Search -->

<!-- ✅ Modal Inscription -->
<div class="modal fade" id="inscriptionModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content border-0 shadow-lg">
            <div class="modal-header" style="background:#1c911e;">
                <h5 class="modal-title text-white"><i class="fa fa-user-plus me-2"></i> Inscription</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <form id="inscriptionForm" method="POST" action="{{ route('clients.store') }}">
                @csrf
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-12">
                            <label class="form-label fw-bold" for="nom">Nom du restaurant/Hôtel</label>
                            <input type="text" id="nom" class="form-control" name="nom" required autocomplete="nom"
                                autofocus value="{{ old('nom') }}">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-bold" for="tel">Téléphone</label>
                            <input type="text" class="form-control" id="tel" name="tel" required autocomplete="tel"
                                value="{{ old('tel') }}">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-bold" for="whatsapp">WhatsApp</label>
                            <input type="text" class="form-control" name="whatsapp" id="whatsapp"
                                value="{{ old('whatsapp') }}">
                        </div>
                        <div class="col-md-12">
                            <label class="form-label fw-bold" for="adresse">Adresse</label>
                            <input type="text" id="adresse" class="form-control" name="adresse" required
                                placeholder="Hamdallaye - Carrefour concasseur" value="{{ old('adresse') }}">
                        </div>
                        <input type="hidden" name="role" value="client">
                        <input type="hidden" name="statut" value="actif">
                    </div>
                </div>
                <div class="modal-footer bg-light">
                    <button type="button" class="btn" style="background:#070a23; color:white;"
                        data-bs-dismiss="modal">Annuler</button>
                    <button type="submit" class="btn" style="background:#1c911e; color:white;">
                        <i class="fa fa-save me-1"></i> Enregistrer
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
<!-- ✅ Fin Modal Inscription -->

<!-- ✅ Modal Voir Commande -->
<div class="modal fade" id="voirCommandeModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content border-0 shadow-lg">
            <div class="modal-header" style="background:#1c911e;">
                <h5 class="modal-title text-white"><i class="fa fa-shopping-cart me-2"></i> Votre commande</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="commande-client-info"></div>
                <table class="table table-bordered mt-3">
                    <thead>
                        <tr class="text-center">
                            <th>Produit</th>
                            <th>Quantité</th>
                            <th>Prix</th>
                            <th>Total</th>
                            <th>X</th>
                        </tr>
                    </thead>
                    <tbody id="commande-produits"></tbody>
                    <tfoot>
                        <tr>
                            <th colspan="3">Total général</th>
                            <th id="total-general">0 GNF</th>
                        </tr>
                    </tfoot>
                </table>
            </div>
            <div class="modal-footer bg-light d-flex justify-content-between">
                <div>
                    <button type="button" class="btn btn-primary" id="btn-vue-facture"><i class="fa fa-eye me-1"></i> </button>
                    <button type="button" class="btn btn-warning" id="btn-download-pdf"><i class="fa fa-file-pdf me-1"></i> PDF</button>
                    <button type="button" class="btn btn-success" id="btn-print-facture"><i class="fa fa-print me-1"></i> </button>
                </div>
                <button type="button" class="btn btn-danger text-light" data-bs-dismiss="modal">Fermer</button>
            </div>
        </div>
    </div>
</div>
<!-- ✅ Fin Modal Voir Commande -->

@push('scripts')
<script>
document.addEventListener("DOMContentLoaded", function () {
    const sideCartList = document.querySelector('.side .cart-list');
    const cartCount = document.getElementById('cart-count');
    const inscriptionForm = document.getElementById('inscriptionForm');
    let produits = [];

    function updateSideCart() {
        sideCartList.querySelectorAll('li:not(.total)').forEach(li => li.remove());
        let totalGeneral = 0;
        produits.forEach((p, index) => {
            totalGeneral += p.total;
            const li = document.createElement('li');
            li.innerHTML = `
                <a href="#" class="photo"><img src="${p.image}" class="cart-thumb" alt="${p.nom}" /></a>
                <h6><a href="#">${p.nom}</a></h6>
                <p>${p.qty}x - <span class="price">${new Intl.NumberFormat('fr-FR').format(p.total)} GNF</span>
                    <button class="btn btn-sm btn-danger float-end btn-annuler" data-index="${index}">
                        <i class="fa fa-times"></i>
                    </button>
                </p>`;
            sideCartList.insertBefore(li, sideCartList.querySelector('.total'));
        });
        sideCartList.querySelector('.total .float-right').innerHTML =
            `<strong>Total</strong>: ${new Intl.NumberFormat('fr-FR').format(produits.reduce((sum, p) => sum + p.total, 0))} GNF`;
        cartCount.textContent = produits.length;

        sideCartList.querySelectorAll('.btn-annuler').forEach(btn => {
            btn.addEventListener('click', function () {
                const i = parseInt(this.dataset.index);
                const removedProduit = produits.splice(i, 1)[0];
                // Décoche dans la table allproduit
                const tableRow = document.querySelector(`#produits-table tbody tr[data-prix="${removedProduit.prix}"]`);
                if (tableRow) {
                    const chk = tableRow.querySelector('.select-produit');
                    const qtyInput = tableRow.querySelector('.qty');
                    if (chk) chk.checked = false;
                    if (qtyInput) qtyInput.value = 0;
                }
                updateSideCart();
            });
        });
    }

    function syncFromTable() {
        const table = document.getElementById('produits-table');
        produits = [];
        table.querySelectorAll('tbody tr').forEach(tr => {
            const chk = tr.querySelector('.select-produit');
            if (chk && chk.checked) {
                const nom = tr.querySelector('td:nth-child(2)').innerText.trim();
                const qty = parseInt(tr.querySelector('.qty').value) || 1;
                const prix = parseFloat(tr.dataset.prix);
                const total = prix * qty;
                const imageTag = tr.querySelector('td:nth-child(2) img');
                const image = imageTag ? imageTag.src : 'https://via.placeholder.com/60';
                produits.push({ nom, qty, prix, total, image });
            }
        });
        updateSideCart();
    }

    document.querySelectorAll('#produits-table .select-produit').forEach(chk => {
        chk.addEventListener('change', syncFromTable);
    });
    document.querySelectorAll('#produits-table .qty').forEach(input => {
        input.addEventListener('input', syncFromTable);
    });

    const btnCommander = document.getElementById('btn-commander');
    btnCommander.addEventListener('click', function () {
        syncFromTable();
        if (produits.length === 0) return;
        let message = "Vous avez passé une commande de :\n";
        let totalGeneral = 0;
        produits.forEach(p => {
            message += `${p.nom} : ${p.qty} x ${new Intl.NumberFormat('fr-FR').format(p.prix)} GNF = ${new Intl.NumberFormat('fr-FR').format(p.total)} GNF\n`;
            totalGeneral += p.total;
        });
        message += `Total à payer : ${new Intl.NumberFormat('fr-FR').format(totalGeneral)} GNF\nConfirmez-vous !`;
        if (confirm(message)) {
            ajouterBoutonConfirmer();
        }
    });

    function ajouterBoutonConfirmer() {
        if (!document.getElementById('btn-confirmer-panier')) {
            const liTotal = sideCartList.querySelector('.total');
            const btnConfirmer = document.createElement('a');
            btnConfirmer.href = "#";
            btnConfirmer.id = "btn-confirmer-panier";
            btnConfirmer.className = "btn btn-success w-100 mt-2";
            btnConfirmer.textContent = "Confirmer la commande";

            btnConfirmer.addEventListener('click', function (e) {
                e.preventDefault();
                const isLoggedIn = @json(auth()->check());
                if (!isLoggedIn) {
                    const modal = new bootstrap.Modal(document.getElementById('inscriptionModal'));
                    modal.show();
                } else {
                    envoyerCommande();
                }
            });

            liTotal.insertAdjacentElement('afterend', btnConfirmer);
        }
    }

    function envoyerCommande(client_id = @json(auth()->check() ? auth()->user()->id : null)) {
        const formData = new FormData();
        formData.append('produits', JSON.stringify(produits));
        formData.append('prix_total', produits.reduce((sum, p) => sum + p.total, 0));
        if (client_id) formData.append('client_id', client_id);

        fetch("{{ route('commandes.store') }}", {
            method: "POST",
            body: formData,
            headers: { "X-CSRF-TOKEN": "{{ csrf_token() }}" }
        })
        .then(res => res.json())
        .then(data => {
            if (data.success) {
                alert("Commande enregistrée avec succès !");
                document.getElementById('btn-confirmer-panier')?.remove();
                produits = [];
                updateSideCart();
                const modalInstance = bootstrap.Modal.getInstance(document.getElementById('inscriptionModal'));
                if (modalInstance) modalInstance.hide();
            } else {
                alert("Erreur lors de l’enregistrement de la commande.");
            }
        })
        .catch(err => console.error("Erreur commande:", err));
    }

    inscriptionForm.addEventListener('submit', function (e) {
        e.preventDefault();
        const formData = new FormData(this);

        fetch("{{ route('clients.store') }}", {
            method: "POST",
            body: formData,
            headers: { "X-CSRF-TOKEN": "{{ csrf_token() }}" }
        })
        .then(res => res.json())
        .then(data => {
            if (data.success && data.client_id) {
                envoyerCommande(data.client_id);
            } else {
                alert("Erreur lors de l'inscription du client.");
            }
        })
        .catch(err => console.error("Erreur client:", err));
    });

    // Bouton Voir pour afficher le modal commande avec édition/suppression
    const btnVoir = sideCartList.querySelector('.btn-cart');
    btnVoir.addEventListener('click', function (e) {
        e.preventDefault();

        let clientInfoHtml = '';
        @if(auth()->check())
            const user = @json(auth()->user());
            clientInfoHtml = `
                <p><strong>Nom :</strong> ${user.name}</p>
                <p><strong>Téléphone :</strong> ${user.tel ?? ''}</p>
                <p><strong>WhatsApp :</strong> ${user.whatsapp ?? ''}</p>
                <p><strong>Adresse :</strong> ${user.adresse ?? ''}</p>
            `;
        @else
            clientInfoHtml = `<p>Vous n'êtes pas connecté.</p>`;
        @endif

        document.getElementById('commande-client-info').innerHTML = clientInfoHtml;

        const tbody = document.getElementById('commande-produits');

        function renderTable() {
            tbody.innerHTML = '';
            let totalGeneral = 0;

            produits.forEach((p, index) => {
                totalGeneral += p.total;
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${p.nom}</td>
                    <td><input type="number" min="1" value="${p.qty}" class="form-control form-control-sm qty-input" data-index="${index}" style="width:80px;"></td>
                    <td>${new Intl.NumberFormat('fr-FR').format(p.prix)} GNF</td>
                    <td class="total-produit">${new Intl.NumberFormat('fr-FR').format(p.total)} GNF</td>
                    <td><button class="btn btn-danger btn-sm btn-supprimer" data-index="${index}"><i class="fa fa-trash"></i></button></td>
                `;
                tbody.appendChild(row);
            });

            document.getElementById('total-general').textContent =
                new Intl.NumberFormat('fr-FR').format(totalGeneral) + ' GNF';

            // Modification quantité dans le modal
            tbody.querySelectorAll('.qty-input').forEach(input => {
                input.addEventListener('input', function () {
                    const i = this.getAttribute('data-index');
                    const newQty = parseInt(this.value);
                    if (newQty > 0) {
                        produits[i].qty = newQty;
                        produits[i].total = produits[i].prix * newQty;

                        // Mise à jour panier
                        updateSideCart();

                        // Mise à jour table allproduit si présent
                        const tableRow = document.querySelector(`#produits-table tbody tr[data-prix="${produits[i].prix}"]`);
                        if (tableRow) {
                            const qtyInput = tableRow.querySelector('.qty');
                            if (qtyInput) qtyInput.value = newQty;
                        }

                        renderTable(); // Re-render
                    }
                });
            });

            // Suppression produit
            tbody.querySelectorAll('.btn-supprimer').forEach(btn => {
                btn.addEventListener('click', function () {
                    const i = this.getAttribute('data-index');
                    const removedProduit = produits.splice(i, 1)[0];

                    // Mise à jour panier
                    updateSideCart();

                    // Décoche et qty=0 dans table allproduit
                    const tableRow = document.querySelector(`#produits-table tbody tr[data-prix="${removedProduit.prix}"]`);
                    if (tableRow) {
                        const chk = tableRow.querySelector('.select-produit');
                        const qtyInput = tableRow.querySelector('.qty');
                        if (chk) chk.checked = false;
                        if (qtyInput) qtyInput.value = 0;
                    }

                    renderTable(); // Re-render
                });
            });
        }

        renderTable();

        // Ouvrir modal
        const modal = new bootstrap.Modal(document.getElementById('voirCommandeModal'));
        modal.show();
    });
});
</script>
@endpush
