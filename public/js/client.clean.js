// public/js/client.clean.js — Clean consolidated client utilities (replacement)
(function () {
    'use strict';

    async function fetchJson(url, opts) { try { const res = await fetch(url, opts); return await res.json(); } catch (e) { console.error('fetchJson', e); return { error: 'Network error' }; } }

    function initIntl(el) { if (!el || !window.intlTelInput) return null; if (el.getAttribute && el.getAttribute('data-iti-initialized')) return null; try { const iti = window.intlTelInput(el, { separateDialCode: true, initialCountry: 'gn', preferredCountries: ['gn', 'sn', 'ci', 'ml'], utilsScript: 'https://cdnjs.cloudflare.com/ajax/libs/intl-tel-input/17.0.19/js/utils.js' }); el.setAttribute('data-iti-initialized', '1'); return iti; } catch (e) { console.warn('initIntl error', e); return null; } }

    function renderClientInfo(payload) { const container = document.getElementById('clientInfo'); if (!container) return; const obj = payload && payload.client ? payload.client : (payload || {}); try { localStorage.setItem('clientInfo', JSON.stringify({ client: obj })); } catch (e) { } const nom = obj.nom || obj.prenom || 'Client'; const tel = obj.tel || obj.whatsapp || '-'; const whatsapp = obj.whatsapp || '-'; const adresse = obj.adresse || '-'; container.innerHTML = `<div class="alert alert-success"><strong>${nom}</strong> <small>${tel} • ${whatsapp}</small><div class="float-end"><button id="logoutBtnTop" class="btn btn-danger">Déconnexion</button></div></div>`; const logoutBtn = document.getElementById('logoutBtnTop'); if (logoutBtn) logoutBtn.onclick = function () { try { localStorage.removeItem('clientInfo'); localStorage.removeItem('panier'); localStorage.removeItem('selectedProducts'); window.authUser = null; } catch (e) { } window.dispatchEvent(new CustomEvent('clientInfoChanged', { detail: null })); window.dispatchEvent(new CustomEvent('authStateChanged')); try { if (window.ALL_PRODUIT_URL) window.location.href = window.ALL_PRODUIT_URL; else window.location.reload(); } catch (e) { window.location.reload(); } } }

    function clearClientInfo() { const container = document.getElementById('clientInfo'); const form = document.getElementById('clientRegistrationForm'); if (!container) return; container.innerHTML = ''; container.style.display = 'none'; if (form) form.style.display = 'block'; }

    async function showClient(id) { const voirModalBody = document.getElementById('voirClientContent'); const voirModalEl = document.getElementById('voirClientModal'); const voirModal = (voirModalEl && window.bootstrap) ? new bootstrap.Modal(voirModalEl) : null; if (!voirModalBody) return; voirModalBody.innerHTML = '<p class="text-center">Chargement...</p>'; const client = await fetchJson(`/clients/${id}/ajax-show`); if (client.error) { voirModalBody.innerHTML = `<p class="text-danger">${client.error}</p>`; return; } const statut = client.statut === 'actif' ? '<span class="text-success">Actif</span>' : '<span class="text-danger">Inactif</span>'; voirModalBody.innerHTML = `<div class="row g-3"><div class="col-md-4 text-center"><img src="${client.image || 'https://via.placeholder.com/150'}" class="img-fluid rounded"/></div><div class="col-md-8"><p><strong>Nom :</strong> ${client.nom}</p><p><strong>Téléphone :</strong> ${client.tel || '-'}</p><p><strong>WhatsApp :</strong> ${client.whatsapp || '-'}</p><p><strong>Adresse :</strong> ${client.adresse || '-'}</p>${client.latitude && client.longitude ? `<p><a href="https://www.google.com/maps?q=${client.latitude},${client.longitude}" target="_blank">Voir sur Google Maps</a></p>` : ''}<p><strong>Statut :</strong> ${statut}</p></div></div>`; if (voirModal) voirModal.show(); }

    async function editClient(id) { const editModalBody = document.getElementById('editClientContent'); const editModalEl = document.getElementById('editClientModal'); const editModal = (editModalEl && window.bootstrap) ? new bootstrap.Modal(editModalEl) : null; if (!editModalBody) return; editModalBody.innerHTML = '<p class="text-center">Chargement...</p>'; const client = await fetchJson(`/clients/${id}/ajax-edit`); if (client.error) { editModalBody.innerHTML = `<p class="text-danger">${client.error}</p>`; return; } editModalBody.innerHTML = `<form id="editClientForm"><div><label>Nom</label><input id="editNom" value="${client.nom || ''}" class="form-control"/></div><div><label>Tél</label><input id="editTel" value="${client.tel || ''}" class="form-control"/></div><div><label>WhatsApp</label><input id="editWhatsapp" value="${client.whatsapp || ''}" class="form-control"/></div><div><label>Adresse</label><input id="editAdresse" value="${client.adresse || ''}" class="form-control"/></div><div class="mt-2 text-end"><button type="button" id="saveClientBtn" class="btn btn-success">Enregistrer</button></div></form>`; const elTel = document.getElementById('editTel'); const elWhatsapp = document.getElementById('editWhatsapp'); const itiTel = initIntl(elTel); const itiWhatsapp = initIntl(elWhatsapp); const saveBtn = document.getElementById('saveClientBtn'); if (saveBtn) saveBtn.addEventListener('click', async () => { const f = new FormData(); f.append('_method', 'PUT'); f.append('nom', document.getElementById('editNom').value || ''); if (itiTel && itiTel.isValidNumber()) { f.append('tel', itiTel.getNumber()); } else { f.append('tel', document.getElementById('editTel').value || ''); } if (itiWhatsapp && itiWhatsapp.isValidNumber()) { f.append('whatsapp', itiWhatsapp.getNumber()); } else { f.append('whatsapp', document.getElementById('editWhatsapp').value || ''); } f.append('adresse', document.getElementById('editAdresse').value || ''); try { const resp = await fetchJson(`/clients/${id}`, { method: 'POST', headers: { 'X-CSRF-TOKEN': (document.querySelector('meta[name="csrf-token"]') || {}).getAttribute ? document.querySelector('meta[name="csrf-token"]').getAttribute('content') : '' }, body: f }); if (resp && resp.success) { if (editModal) editModal.hide(); location.reload(); } else { alert(resp.message || 'Erreur'); } } catch (e) { console.error(e); alert('Erreur'); } }); if (editModal) editModal.show(); }

    document.addEventListener('click', function (e) { const view = e.target.closest && e.target.closest('.btn-view'); if (view) { e.preventDefault(); const id = view.dataset.id; if (id) showClient(id); return; } const edit = e.target.closest && e.target.closest('.btn-edit'); if (edit) { e.preventDefault(); const id = edit.dataset.id; if (id) editClient(id); return; } });

    document.addEventListener('DOMContentLoaded', function () { const tel = document.getElementById('tel'); const wa = document.getElementById('whatsapp'); const formAdd = document.getElementById('formAjoutClient'); const itiTel = initIntl(tel); const itiWa = initIntl(wa); if (formAdd) formAdd.addEventListener('submit', function () { try { const hTel = document.getElementById('tel_e164'); if (itiTel && hTel) hTel.value = itiTel.getNumber(); } catch (e) { console.warn(e); } try { const hWa = document.getElementById('whatsapp_e164'); if (itiWa && hWa) hWa.value = itiWa.getNumber(); } catch (e) { console.warn(e); } }); try { const stored = JSON.parse(localStorage.getItem('clientInfo')); if (stored && stored.client) renderClientInfo(stored); else if (typeof window.authUser !== 'undefined' && window.authUser !== null) renderClientInfo({ client: window.authUser }); } catch (e) { /* ignore */ } });

    window.appClient = window.appClient || {};
    window.appClient.showClient = showClient;
    window.appClient.editClient = editClient;
})();
